<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekapitulasi KIB B - Dinas Pendidikan Kab. Donggala</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2, h3 { margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid black; padding: 5px; text-align: center; font-size: 12px; }
    th { background-color: #f2f2f2; }
    button { margin: 5px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
    #downloadExcel { background:#2c7be5; color:#fff; }
    #downloadPDF { background:#28a745; color:#fff; }
    canvas { max-width: 400px; max-height: 250px; }
    .chart-row { display: flex; justify-content: space-between; margin-top: 20px; }
    .chart-col { flex: 1; text-align: center; }
    .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; border-bottom:1px solid black; padding-bottom:10px; }
    .header img { width: 60px; }
    .instansi { font-weight: bold; font-size: 14px; }
  </style>
</head>
<body>

  <div class="header">
    <img src="https://upload.wikimedia.org/wikipedia/commons/e/e5/Lambang_Kabupaten_Donggala_%282015-sekarang%29.png" alt="Logo">
    <div>
      <div class="instansi">DINAS PENDIDIKAN DAN KEBUDAYAAN<br>KABUPATEN DONGGALA</div>
      <div>Alamat: Jalan Jati, Kelurahan Gunung Bale</div>
      <div class="periode">Periode: Tahun 2025</div>
    </div>
  </div>

  <button id="downloadExcel">Download Excel</button>
  <button id="downloadPDF">Download PDF</button>

  <div id="summarySection">
    <h3>Summary Rekap</h3>
    <table id="rekapTable">
      <thead>
        <tr>
          <th>Kecamatan</th>
          <th>Ditemukan</th>
          <th>Tidak Ditemukan</th>
          <th>Baik</th>
          <th>Rusak Ringan</th>
          <th>Rusak Berat</th>
          <th>Nilai Perolehan (Rp)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="chart-row">
    <div class="chart-col">
      <h4>Nilai Perolehan per Kecamatan</h4>
      <canvas id="globalChart"></canvas>
    </div>
    <div class="chart-col">
      <h4>Distribusi Kondisi Barang</h4>
      <canvas id="pieChart"></canvas>
    </div>
  </div>

<script>
// daftar URL CSV per kecamatan (contoh, tambahkan semua sesuai kebutuhan)
const dataKecamatan = {
  "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRd8vIhHDUbmD6I2aXLX7-_Ysemt2aXA__wKNGoKN0XWWSWCScv5aSmx06H0xkl8g/pub?gid=1917777904&single=true&output=csv",
  "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnykw5e_i3dwBIeTua-mpFExEJ4w6hROJ5F6OUHiiGpbtunldeKgXlhN_G-D1V8w/pub?gid=1454720232&single=true&output=csv",
  "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv",
  "Labuan": "https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv",
  "Sindue": "https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv",
  "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv",
  "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv",
  "Sirenja": "https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv",
  "Balaesang": "https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv",
  "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv",
  "Dampelas": "https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv",
  "Sojol": "https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv",
  "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv"
};

// parsing CSV sederhana
function parseCSV(text) {
  const [headerLine, ...lines] = text.trim().split("\n");
  const headers = headerLine.split(",");
  return lines.map(line => {
    const cols = line.split(",");
    let obj = {};
    headers.forEach((h,i)=> obj[h.trim()] = cols[i] ? cols[i].trim() : "");
    obj.nilai = parseFloat(obj.nilai || 0);
    return obj;
  });
}

async function loadData() {
  const tbody = document.querySelector("#rekapTable tbody");
  let totalAll = { ditemu:0, tditemu:0, baik:0, ringan:0, berat:0, nilai:0 };
  let chartLabels = [];
  let chartValues = [];

  for (const [kec, url] of Object.entries(dataKecamatan)) {
    try {
      const res = await fetch(url);
      const text = await res.text();
      const rows = parseCSV(text);

      const ditemu = rows.filter(r=>r.konfirmasi==="Ditemukan").length;
      const tditemu = rows.filter(r=>r.konfirmasi!=="Ditemukan").length;
      const baik = rows.filter(r=>r.kondisi==="Baik").length;
      const ringan = rows.filter(r=>r.kondisi==="Rusak Ringan").length;
      const berat = rows.filter(r=>r.kondisi==="Rusak Berat").length;
      const nilai = rows.reduce((a,b)=>a+(b.nilai||0),0);

      tbody.innerHTML += `<tr>
        <td>${kec}</td><td>${ditemu}</td><td>${tditemu}</td>
        <td>${baik}</td><td>${ringan}</td><td>${berat}</td>
        <td>${nilai.toLocaleString("id-ID",{minimumFractionDigits:2, maximumFractionDigits:2})}</td></tr>`;

      totalAll.ditemu += ditemu;
      totalAll.tditemu += tditemu;
      totalAll.baik += baik;
      totalAll.ringan += ringan;
      totalAll.berat += berat;
      totalAll.nilai += nilai;

      chartLabels.push(kec);
      chartValues.push(nilai);

    } catch(err) {
      console.error("Gagal fetch "+kec, err);
    }
  }

  // total
  tbody.innerHTML += `<tr style="font-weight:bold; background:#f2f2f2">
    <td>TOTAL</td><td>${totalAll.ditemu}</td><td>${totalAll.tditemu}</td>
    <td>${totalAll.baik}</td><td>${totalAll.ringan}</td><td>${totalAll.berat}</td>
    <td>${totalAll.nilai.toLocaleString("id-ID",{minimumFractionDigits:2, maximumFractionDigits:2})}</td></tr>`;

  // chart batang
  new Chart(document.getElementById("globalChart"), {
    type:"bar",
    data:{ labels:chartLabels,
      datasets:[{ label:"Nilai Perolehan (Rp)", data:chartValues, backgroundColor:"#2c7be5"}]
    }
  });

  // pie chart
  new Chart(document.getElementById("pieChart"), {
    type:"pie",
    data:{
      labels:["Baik","Rusak Ringan","Rusak Berat"],
      datasets:[{ data:[totalAll.baik,totalAll.ringan,totalAll.berat],
        backgroundColor:["#28a745","#ffc107","#dc3545"] }]
    }
  });
}

loadData();

// Export PDF
document.getElementById("downloadPDF").addEventListener("click", ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(12);
  doc.text("DINAS PENDIDIKAN DAN KEBUDAYAAN", 14, 12);
  doc.text("KABUPATEN DONGGALA", 14, 18);
  doc.text("Jl. Jati, Kel. Gunung Bale", 14, 24);
  doc.text("Rekapitulasi Inventaris Barang Milik Daerah (KIB B)", 14, 32);
  doc.text("Periode: Tahun 2025", 14, 38);

  const tbody = document.querySelector("#rekapTable tbody");
  const tableData = [...tbody.querySelectorAll("tr")].map(tr=>[...tr.querySelectorAll("td")].map(td=>td.textContent));
  doc.autoTable({
    head:[["Kecamatan","Ditemukan","Tidak Ditemukan","Baik","Rusak Ringan","Rusak Berat","Nilai (Rp)"]],
    body:tableData,
    startY:45,
    styles:{ fontSize:8 },
    theme:'grid'
  });

  const yCharts = doc.lastAutoTable.finalY + 8;
  const chartImg = document.getElementById("globalChart").toDataURL("image/png");
  const pieImg = document.getElementById("pieChart").toDataURL("image/png");

  doc.setFontSize(10);
  doc.text("Nilai Perolehan per Kecamatan", 40, yCharts);
  doc.text("Distribusi Kondisi Barang", 135, yCharts);

  doc.addImage(chartImg,"PNG",20,yCharts+4,80,60);
  doc.addImage(pieImg,"PNG",115,yCharts+4,80,60);

  doc.text("A.n Kepala Dinas Pendidikan dan Kebudayaan", 120, 270);
  doc.text("IRAWAN PANGIDEN, S.IP., M.Si", 120, 278);
  doc.text("NIP. 19750331 199403 1 003", 120, 286);

  doc.save("Rekap_KIBB.pdf");
});
</script>
</body>
</html>
