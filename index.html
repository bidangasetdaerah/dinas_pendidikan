<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap KIB B - Dinas Pendidikan Donggala</title>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    .header { display:flex; align-items:center; border-bottom:2px solid black; padding-bottom:10px; margin-bottom:20px; }
    .header img { height:70px; margin-right:15px; }
    .header .instansi { font-size:14px; font-weight:bold; text-transform:uppercase; }
    .periode { margin-top:5px; font-size:13px; font-style:italic; }
    button { background:#001f3f;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer; margin-right:5px; }
    table { border-collapse:collapse; width:100%; margin-top:15px; }
    th, td { border:1px solid black; padding:4px; font-size:12px; }
    th { background:#f0f0f0; }
    .total { background:yellow; font-weight:bold; }
    .chart-container { width:70%; height:300px; margin:20px auto; }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://upload.wikimedia.org/wikipedia/commons/0/0f/Lambang_Kabupaten_Donggala.png" alt="Logo">
    <div>
      <div class="instansi">DINAS PENDIDIKAN DAN KEBUDAYAAN<br>KABUPATEN DONGGALA</div>
      <div>Alamat: Jalan Jati, Kelurahan Gunung Bale</div>
      <div class="periode">Periode: Tahun 2025</div>
    </div>
  </div>

  <button id="downloadExcel">⬇️ Download Excel</button>
  <button id="downloadPDF">⬇️ Download PDF</button>

  <div class="chart-container">
    <canvas id="rekapChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="pieChart"></canvas>
  </div>

  <table id="rekapTable">
    <thead>
      <tr>
        <th>Kecamatan</th><th>Ditemukan</th><th>Tidak Ditemukan</th>
        <th>Baik</th><th>Rusak Ringan</th><th>Rusak Berat</th><th>Nilai Perolehan (Rp)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const dataKecamatan = {
  "Banawa": [
    { sekolah:"SDN 1 Banawa", barang:"Meja", nibar:"123", konfirmasi:"Ditemukan", kondisi:"Baik", nilai:1200000 },
    { sekolah:"SDN 1 Banawa", barang:"Kursi", nibar:"124", konfirmasi:"Ditemukan", kondisi:"Rusak Ringan", nilai:500000 }
  ],
  "Sindue": [
    { sekolah:"SDN 2 Sindue", barang:"Lemari", nibar:"125", konfirmasi:"Tidak Ditemukan", kondisi:"Rusak Berat", nilai:750000 }
  ]
};

// ====== Rekap Table + Chart ======
const tbody = document.querySelector("#rekapTable tbody");
const kecLabels=[], totalNilai=[];
let totalGlobal={ditemukan:0, tidak:0, baik:0, rr:0, rb:0, nilai:0};

for (const [kec,data] of Object.entries(dataKecamatan)) {
  const ditemukan=data.filter(d=>d.konfirmasi==="Ditemukan").length;
  const tidak=data.filter(d=>d.konfirmasi!=="Ditemukan").length;
  const baik=data.filter(d=>d.kondisi==="Baik").length;
  const rr=data.filter(d=>d.kondisi==="Rusak Ringan").length;
  const rb=data.filter(d=>d.kondisi==="Rusak Berat").length;
  const nilai=data.reduce((a,b)=>a+b.nilai,0);

  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${kec}</td><td>${ditemukan}</td><td>${tidak}</td>
                <td>${baik}</td><td>${rr}</td><td>${rb}</td><td>${nilai.toFixed(2)}</td>`;
  tbody.appendChild(tr);

  kecLabels.push(kec); totalNilai.push(nilai);
  totalGlobal.ditemukan+=ditemukan; totalGlobal.tidak+=tidak;
  totalGlobal.baik+=baik; totalGlobal.rr+=rr; totalGlobal.rb+=rb; totalGlobal.nilai+=nilai;
}
// add total row to summary table
const trTotal=document.createElement("tr");
trTotal.classList.add("total");
trTotal.innerHTML=`<td>TOTAL</td><td>${totalGlobal.ditemukan}</td><td>${totalGlobal.tidak}</td>
                   <td>${totalGlobal.baik}</td><td>${totalGlobal.rr}</td><td>${totalGlobal.rb}</td>
                   <td>${totalGlobal.nilai.toFixed(2)}</td>`;
tbody.appendChild(trTotal);

// Chart batang (Nilai per kecamatan)
const chartRef=document.getElementById("rekapChart");
const globalChart=new Chart(chartRef, {
  type:'bar',
  data:{ labels:kecLabels, datasets:[{ label:"Nilai Perolehan", data:totalNilai, backgroundColor:"#0074D9" }] },
  options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, 
            scales:{ y:{ beginAtZero:true } } }
});

// Chart pie (Kondisi global)
const pieRef=document.getElementById("pieChart");
const pieChart=new Chart(pieRef, {
  type:'pie',
  data:{
    labels:["Baik","Rusak Ringan","Rusak Berat"],
    datasets:[{
      data:[totalGlobal.baik,totalGlobal.rr,totalGlobal.rb],
      backgroundColor:["#2ECC40","#FFDC00","#FF4136"]
    }]
  },
  options:{ responsive:true, maintainAspectRatio:false }
});

// ====== Download PDF ======
document.getElementById("downloadPDF").addEventListener("click", async ()=>{
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF(); const periode="Tahun 2025";

  // ===== Summary page =====
  doc.setFontSize(12);
  doc.text("DINAS PENDIDIKAN DAN KEBUDAYAAN",14,10);
  doc.text("KABUPATEN DONGGALA",14,16);
  doc.text("Jl. Jati, Kel. Gunung Bale",14,22);
  doc.text("REKAPITULASI INVENTARIS KIB B (Summary)",14,30);
  doc.text(`Periode: ${periode}`,14,36);

  // table summary
  let body=[];
  for (const kec of kecLabels){
    const data=dataKecamatan[kec];
    const ditemukan=data.filter(d=>d.konfirmasi==="Ditemukan").length;
    const tidak=data.filter(d=>d.konfirmasi!=="Ditemukan").length;
    const baik=data.filter(d=>d.kondisi==="Baik").length;
    const rr=data.filter(d=>d.kondisi==="Rusak Ringan").length;
    const rb=data.filter(d=>d.kondisi==="Rusak Berat").length;
    const nilai=data.reduce((a,b)=>a+b.nilai,0);
    body.push([kec,ditemukan,tidak,baik,rr,rb,nilai.toFixed(2)]);
  }
  body.push(["TOTAL",totalGlobal.ditemukan,totalGlobal.tidak,totalGlobal.baik,totalGlobal.rr,totalGlobal.rb,totalGlobal.nilai.toFixed(2)]);
  doc.autoTable({startY:44, head:[["Kecamatan","Ditemukan","Tdk Ditemukan","Baik","Rusak R","Rusak B","Nilai"]],
    body, theme:'grid', styles:{fontSize:7},
    didParseCell:(data)=>{
      if(data.row.raw[0]==="TOTAL"){ data.cell.styles.fillColor=[255,255,0]; data.cell.styles.fontStyle="bold"; }
    }});

  // export charts sejajar
  const chartImg=globalChart.toBase64Image();
  const pieImg=pieChart.toBase64Image();
  const yCharts=doc.lastAutoTable.finalY+6;
  doc.addImage(chartImg,"PNG",20,yCharts,80,60);   // kiri
  doc.addImage(pieImg,"PNG",115,yCharts,80,60);    // kanan

  // footer tanda tangan
  const h=doc.internal.pageSize.height;
  doc.text("A.n Kepala Dinas Pendidikan dan Kebudayaan",140,h-30);
  doc.text("IRAWAN PANGIDEN, S.IP., M.Si",140,h-18);
  doc.text("NIP. 19750331 199403 1 003",140,h-6);

  // ===== Detail per kecamatan =====
  for (const [kec,data] of Object.entries(dataKecamatan)) {
    doc.addPage();
    doc.setFontSize(12);
    doc.text("DINAS PENDIDIKAN DAN KEBUDAYAAN",14,10);
    doc.text("KABUPATEN DONGGALA",14,16);
    doc.text("Jl. Jati, Kel. Gunung Bale",14,22);
    doc.text(`Rekapitulasi KIB B - Kecamatan ${kec}`,14,30);
    doc.text(`Periode: ${periode}`,14,36);
    let startY=44;
    const sekolahMap={};
    data.forEach(r=>{
      if(!sekolahMap[r.sekolah]) sekolahMap[r.sekolah]={barang:0,nilai:0,detail:[]};
      sekolahMap[r.sekolah].barang++; sekolahMap[r.sekolah].nilai+=r.nilai; sekolahMap[r.sekolah].detail.push(r);
    });
    let total={barang:0,ditemukan:0,tidak:0,baik:0,rr:0,rb:0,nilai:0};
    let body=[];
    for (const [sName,val] of Object.entries(sekolahMap)) {
      let ditemukan=val.detail.filter(d=>d.konfirmasi==="Ditemukan").length;
      let tidak=val.detail.filter(d=>d.konfirmasi!=="Ditemukan").length;
      let baik=val.detail.filter(d=>d.kondisi==="Baik").length;
      let rr=val.detail.filter(d=>d.kondisi==="Rusak Ringan").length;
      let rb=val.detail.filter(d=>d.kondisi==="Rusak Berat").length;
      body.push([sName,val.barang,ditemukan,tidak,baik,rr,rb,val.nilai.toFixed(2)]);
      total.barang+=val.barang; total.ditemukan+=ditemukan; total.tidak+=tidak;
      total.baik+=baik; total.rr+=rr; total.rb+=rb; total.nilai+=val.nilai;
    }
    body.push(["TOTAL",total.barang,total.ditemukan,total.tidak,total.baik,total.rr,total.rb,total.nilai.toFixed(2)]);
    doc.autoTable({startY, head:[["Sekolah","Jml","Ditemukan","Tdk Ditemukan","Baik","Rusak R","Rusak B","Nilai"]],
      body, theme:'grid', styles:{fontSize:7}, headStyles:{fillColor:[200,200,200]}, 
      didParseCell: data=>{
        if(data.row.raw[0]==="TOTAL"){ data.cell.styles.fillColor=[255,255,0]; data.cell.styles.fontStyle="bold"; }
      }});
    startY=doc.lastAutoTable.finalY+6;
    for (const [sName,val] of Object.entries(sekolahMap)) {
      doc.autoTable({startY, head:[["Barang","NIBAR","Konfirmasi","Kondisi","Nilai"]],
        body: val.detail.map(d=>[d.barang,d.nibar,d.konfirmasi,d.kondisi,d.nilai.toFixed(2)]),
        theme:'grid', styles:{fontSize:7}});
      startY=doc.lastAutoTable.finalY+6;
    }
    const h2=doc.internal.pageSize.height;
    doc.text("A.n Kepala Dinas Pendidikan dan Kebudayaan",140,h2-30);
    doc.text("IRAWAN PANGIDEN, S.IP., M.Si",140,h2-18);
    doc.text("NIP. 19750331 199403 1 003",140,h2-6);
  }
  doc.save("Rekap_KIBB_Lengkap.pdf");
});
</script>
</body>
</html>
